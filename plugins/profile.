import { UserProfile, UserMessage } from './models.js';
import { medoBK9 } from './profiles.js'; // Import the model from the appropriate file

let profileHandler = async function (context, { conn, text, command, isAdmin }) {
    try {
        if (command === 'بروفايل') {
            if (!context.isGroup) {
                context.reply('هذا الأمر يعمل فقط في المجموعات');
                return;
            }

            const userId = context.sender.split('@')[0];
            const profile = await UserProfile.findOne({ groupId: context.chat, userId });
            const messageCountDoc = await UserMessage.findOne({ groupId: context.chat, userId });
            const titleDoc = await medoBK9.findOne({ userId, groupId: context.chat });

            if (profile) {
                const title = titleDoc ? titleDoc.bk9 : 'لم يتم تعيين لقب';
                const messageCount = messageCountDoc ? messageCountDoc.messageCount : 0;
                context.reply(`┇ لقبك: ${title}\n┇ عدد الرسائل: ${messageCount}`);
            } else {
                context.reply('┇ لم يتم إنشاء ملفك الشخصي بعد.');
            }
        } else if (command === 'ملف_الاعضاء') {
            if (!context.isGroup) {
                context.reply('هذا الأمر يعمل فقط في المجموعات');
                return;
            }

            if (!isAdmin) {
                context.reply('هذا الأمر متاح فقط للإداريين');
                return;
            }

            const profiles = await UserProfile.find({ groupId: context.chat });
            const messageCounts = await UserMessage.find({ groupId: context.chat });
            const titles = await medoBK9.find({ groupId: context.chat });

            let profileList = '';
            profiles.forEach(profile => {
                const messageCount = messageCounts.find(count => count.userId === profile.userId)?.messageCount || 0;
                const title = titles.find(t => t.userId === profile.userId)?.bk9 || 'بدون لقب';
                profileList += `┇ ${title} - عدد الرسائل: ${messageCount}\n`;
            });

            context.reply(`┇ ملفات الأعضاء:\n\n${profileList || 'لا توجد بيانات للأعضاء.'}`);
        } else if (command.startsWith('إنشاء_ملف')) {
            if (!context.isGroup) {
                context.reply('هذا الأمر يعمل فقط في المجموعات');
                return;
            }

            const [_, ...titleParts] = text.split(' ');
            const title = titleParts.join(' ');
            const userId = context.sender.split('@')[0];

            let profile = await UserProfile.findOne({ groupId: context.chat, userId });

            if (profile) {
                profile.لقب = title;
                await profile.save();
                context.reply('تم تحديث ملفك الشخصي بنجاح.');
            } else {
                profile = new UserProfile({ groupId: context.chat, userId, لقب: title });
                await profile.save();
                context.reply('تم إنشاء ملفك الشخصي بنجاح.');
            }
        }
    } catch (error) {
        console.error('خطأ:', error);
    }
};

profileHandler.command = ['بروفايل', 'ملف_الاعضاء', 'إنشاء_ملف'];
profileHandler.tags = ['profile'];

export default profileHandler;
 